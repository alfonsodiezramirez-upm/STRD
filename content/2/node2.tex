En el nodo 2 se han implementado también todas las tareas y requisitos pedidos
en el documento de requisitos.

La tarea de actualización del modo de funcionamiento viene definida por el código
\ref{lst:modetask}:

\lstinputlisting[style=C,caption={Tarea esporádica que controla el modo.},label={lst:modetask},linerange={110-124},firstnumber=110]{source-code/node2/Src/main.c}

Dicha tarea espera a un semáforo binario que indica que se ha producido una interrupción
(línea 119). Una vez desbloqueada, incrementa el modo hasta un máximo de `2' (línea 120)
y finalmente actualiza el objeto protegido \texttt{mode} (códigos \ref{lst:mode_h} y
\ref{lst:mode_c}).

Por otra parte, como hace falta liberar el semáforo cuando se produce la interrupción
del pulsador, es necesario definir un nuevo fragmento del código que habilite a la
placa para esa tarea (código \ref{lst:exti}):

\lstinputlisting[style=C,caption={Rutina de tratamiento de interrupciones.},label={lst:exti},linerange={663-675},firstnumber=663]{source-code/node2/Src/main.c}

Cuando se activa el GPIO3 se ``devolverá'' el semáforo, lo que permitirá que la tarea
esporádica pueda adquirirlo y realizar su ejecución. Sin embargo, cuando lo intente
adquirir de nuevo se bloqueará y hasta que no se repita este proceso quedará a la
espera de que se libere el semáforo.

Por otra parte, la tarea que se encarga de detectar si hay o no volantazos viene definida
por el código \ref{lst:wheel-task}:

\lstinputlisting[style=C,caption={Tarea periódica de control del giro del volante.},label={lst:wheel-task},linerange={126-159},firstnumber=126]{source-code/node2/Src/main.c}

En dicha tarea se lee desde el ADC (canal 0) y se actualiza el valor de la posición
del volante en la variable \texttt{actual} (líneas 139 -- 146); a continuación se
conserva el dato en el objeto protegido \texttt{symptoms} (línea 147) y se comprueba,
accediendo a la velocidad actual, si el conductor está dando volantazos o no. Esto se
realiza en las líneas 148 -- 155, en donde se aprovechan los recursos provistos por
el objeto protegido \texttt{wheel} para verificar si la se ha pegado un volantazo
(códigos \ref{lst:symptoms_h} y \ref{lst:symptoms_c}). Si durante 13 iteraciones no se ha
reseteado el contador (no ha habido volantazo) se quita el síntoma.

En lo referente a la tarea que identifica si el volante está siendo sujeto o no, se
define mediante el código \ref{lst:grabtask}:

\lstinputlisting[style=C,caption={Tarea periódica de control de sujección del volante.},label={lst:grabtask},linerange={161-174},firstnumber=161]{source-code/node2/Src/main.c}

Dicha tarea sencillamente leerá el valor del GPIO correspondiente (línea 170) y actualizará
el valor en el objeto protegido (línea 171), definido en los códigos \ref{lst:symptoms_h}
y \ref{lst:symptoms_c}.

Para trabajar con la inclinación de la cabeza, se ha de acceder a los valores provistos por
el giroscopio integrado en la placa. El código de la tarea viene definido por
\ref{lst:headtask}:

\lstinputlisting[style=C,caption={Tarea periódica de control de la inclinación de la cabeza.},label={lst:headtask},linerange={176-211},firstnumber=176]{source-code/node2/Src/main.c}

De todo el código anterior, los datos se actualizan en la línea 207 en donde guardan en
el objeto protegido \texttt{symptoms} (códigos \ref{lst:symptoms_h} y \ref{lst:symptoms_c}).
